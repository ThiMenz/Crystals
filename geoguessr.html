
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Geography Quiz</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      display: flex;
    }
    .tree {
      width: 30%;
      max-height: 90vh;
      overflow-y: auto;
      background: white;
      padding: 10px;
      margin-right: 20px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .quiz {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      background: #007BFF;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    .answer {
      background: #e0ffe0;
      padding: 10px;
      border: 1px solid #90ee90;
      border-radius: 5px;
    }
    label {
      display: block;
      margin-left: 20px;
    }
    h3 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <h1>Geography Quiz</h1>
  <div class="container">
    <div class="tree" id="treeContainer"></div>
    <div class="quiz">
      <div id="quizDisplay"></div>
      <button id="quizButton" onclick="quizButtonHandler()">Start Quiz</button>
    </div>
  </div>
  <script>
    const data = {
      Europe: {
        Germany: {
          header: {
            Culture: [
              { url: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Brandenburger_Tor_abends.jpg/640px-Brandenburger_Tor_abends.jpg", html: "<p>The Brandenburg Gate is a neoclassical monument in Berlin.</p>" }
            ]
          }
        }
      },
      Asia: {
        Japan: {
          header: {
            Nature: [
              { url: "https://upload.wikimedia.org/wikipedia/commons/6/6e/Mount_Fuji_from_Hakone.jpg", html: "<p>Mount Fuji is the highest volcano in Japan.</p>" }
            ]
          }
        }
      }
    };

    let selections = {};
    let treeState = {};
    let recentQuestions = [];
    let currentQuizQuestion = null;

    function buildTree(container, obj, path = []) {
      const ul = document.createElement("ul");
      for (const key in obj) {
        const li = document.createElement("li");
        const currentPath = [...path, key];
        const id = currentPath.join("-");

        const expandBtn = document.createElement("button");
        expandBtn.textContent = treeState[id] ? "[-]" : "[+]";
        expandBtn.style.marginRight = "5px";
        expandBtn.onclick = () => {
          treeState[id] = !treeState[id];
          renderTree();
        };

        li.appendChild(expandBtn);
        li.appendChild(document.createTextNode(key));

        if (typeof obj[key] === "object") {
          if (!treeState[id]) {
            ul.appendChild(li);
            continue;
          }
          const child = buildTree(container, obj[key], currentPath);
          if (child) li.appendChild(child);
        }

        if (Array.isArray(obj[key])) {
          const checkboxes = document.createElement("div");
          selections[path[0]] ??= {};
          selections[path[0]][path[1]] ??= {};
          selections[path[0]][path[1]][path[2]] ??= {};
          obj[key].forEach((item, index) => {
            selections[path[0]][path[1]][path[2]][index] ??= false;
            const label = document.createElement("label");
            const input = document.createElement("input");
            input.type = "checkbox";
            input.checked = selections[path[0]][path[1]][path[2]][index];
            input.onchange = () => {
              selections[path[0]][path[1]][path[2]][index] = input.checked;
              saveProfile();
            };
            label.appendChild(input);
            label.appendChild(document.createTextNode(` Question ${index + 1}`));
            checkboxes.appendChild(label);
          });
          li.appendChild(checkboxes);
        }

        ul.appendChild(li);
      }
      return ul;
    }

    function renderTree() {
      const container = document.getElementById("treeContainer");
      container.innerHTML = "";
      container.appendChild(buildTree(container, data));
    }

    function saveProfile() {
      localStorage.setItem("quizProfile", JSON.stringify(selections));
    }

    function loadProfile() {
      const saved = localStorage.getItem("quizProfile");
      if (saved) selections = JSON.parse(saved);
    }

    function getAllSelectedQuestions() {
      let available = [];
      for (const continent in data) {
        for (const country in data[continent]) {
          const headers = data[continent][country].header;
          for (const header in headers) {
            headers[header].forEach((step, index) => {
              if (selections[continent]?.[country]?.[header]?.[index]) {
                available.push({
                  id: `${continent}-${country}-${header}-${index}`,
                  continent, country, header, index, data: step
                });
              }
            });
          }
        }
      }
      return available;
    }

    function isImage(url) {
      return url.match(/\.(jpeg|jpg|gif|png)$/i);
    }

    function quizButtonHandler() {
      const quizDisplay = document.getElementById('quizDisplay');

      if (currentQuizQuestion && !currentQuizQuestion.answerShown) {
        const answerDiv = document.createElement('div');
        answerDiv.className = 'answer';
        answerDiv.style.marginTop = '10px';
        answerDiv.innerHTML = currentQuizQuestion.data.html;
        quizDisplay.appendChild(answerDiv);
        currentQuizQuestion.answerShown = true;
        document.getElementById('quizButton').textContent = "Next Question";
        return;
      }

      const available = getAllSelectedQuestions();
      if (available.length === 0) {
        alert("No entries selected for the quiz. Please adjust your selections.");
        return;
      }

      const filtered = available.filter(q => !recentQuestions.includes(q.id));
      const candidates = filtered.length ? filtered : available;
      const randomEntry = candidates[Math.floor(Math.random() * candidates.length)];

      recentQuestions.push(randomEntry.id);
      if (recentQuestions.length > 5) recentQuestions.shift();

      currentQuizQuestion = { ...randomEntry, answerShown: false };

      let questionContent = "";
      if (isImage(randomEntry.data.url)) {
        questionContent = `<img src="${randomEntry.data.url}" alt="Quiz Image" style="max-width:100%; height:auto;" />`;
      } else {
        questionContent = `<iframe src="${randomEntry.data.url}" style="width:100%; height:300px;" frameborder="0"></iframe>`;
      }

      quizDisplay.innerHTML = `
        <h3>${randomEntry.country} - ${randomEntry.header} (Question ${randomEntry.index + 1})</h3>
        <div>${questionContent}</div>
      `;
      document.getElementById('quizButton').textContent = "Show Answer";
    }

    document.addEventListener('keydown', (e) => {
      if (e.code === "Space" && !e.repeat) {
        e.preventDefault();
        quizButtonHandler();
      }
    });

    loadProfile();
    renderTree();
  </script>
</body>
</html>
