<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Geo Quiz & Map Explorer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f7fa;
      font-size: 18px;
    }
    #container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #sidebar {
      width: 350px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
      padding: 20px;
      box-sizing: border-box;
      background: linear-gradient(135deg, #ffffff, #e6f0f8);
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      min-width: 200px;
      max-width: 800px;
    }
    #sidebar h2 {
      margin-top: 0;
      font-size: 1.6em;
      color: #333;
    }
    #verticalDragBar {
      width: 5px;
      cursor: col-resize;
      background-color: #ccc;
      transition: background-color 0.2s ease;
    }
    #verticalDragBar:hover {
      background-color: #888;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    #mapWrapper {
      position: relative;
      border-bottom: 1px solid #ccc;
      height: 50%;
      min-height: 100px;
    }
    #basicMap, iframe {
      width: 100%;
      height: 100%;
    }
    #horizontalDragBar {
      height: 5px;
      cursor: row-resize;
      background-color: #ccc;
      transition: background-color 0.2s ease;
    }
    #horizontalDragBar:hover {
      background-color: #888;
    }
    #quiz {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background-color: #fff;
    }
    .answer {
      font-size: 1.4em;
      margin-top: 10px;
    }
    #profileSection {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }
    #profileSection h3 {
      margin: 0 0 10px;
      color: #555;
    }
    #profileSection ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    #profileSection li {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #profileSection li button {
      padding: 3px 8px;
      font-size: 0.9em;
      cursor: pointer;
      border: 1px solid #007acc;
      background-color: #fff;
      color: #007acc;
      border-radius: 3px;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    #profileSection li button:hover {
      background-color: #007acc;
      color: #fff;
    }
    .collapsible {
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
      margin: 3px 0;
    }
    .collapsible:hover {
      background-color: rgba(0, 122, 204, 0.1);
    }
    .content {
      margin-left: 15px;
      display: none;
    }
    .expanded > .content {
      display: block;
    }
    label {
      cursor: pointer;
    }
    button {
      margin: 5px 0;
      cursor: pointer;
      border: none;
      background-color: #007acc;
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #005fa3;
    }
    /* Style for History Review section */
    #historyReview {
      margin-top: 20px;
      padding: 10px;
      border: 1px dashed #888;
      border-radius: 4px;
      background: #f9f9f9;
    }
    #historyReview input {
      width: 60px;
      margin-right: 10px;
      padding: 2px 4px;
      font-size: 1em;
    }
  </style>
  <script src="https://openlayers.org/api/OpenLayers.js"></script>
</head>
<body onload="init();">
  <div id="container">
    <!-- Sidebar for tree selection and profiles -->
    <div id="sidebar">
      <h2>Selection Tree</h2>
      <div id="treeContainer"></div>
      
      //<Optional: Global Step Selector (uncomment if desired) 
      <div id="globalStepSelector" style="margin: 20px 0; padding: 10px; background: #e0f7ff; border-radius: 4px;">
        <h3>Global Step Selector</h3>
        <div>
          <span>Step 1:</span>
          <button onclick="toggleStepForAllCountries(0, true)" aria-label="Select all Step 1">Select</button>
          <button onclick="toggleStepForAllCountries(0, false)" aria-label="Deselect all Step 1">Deselect</button>
        </div>
        <div>
          <span>Step 2:</span>
          <button onclick="toggleStepForAllCountries(1, true)" aria-label="Select all Step 2">Select</button>
          <button onclick="toggleStepForAllCountries(1, false)" aria-label="Deselect all Step 2">Deselect</button>
        </div>
        <div>
          <span>Step 3:</span>
          <button onclick="toggleStepForAllCountries(2, true)" aria-label="Select all Step 3">Select</button>
          <button onclick="toggleStepForAllCountries(2, false)" aria-label="Deselect all Step 3">Deselect</button>
        </div>
        <div>
          <span>Step 4:</span>
          <button onclick="toggleStepForAllCountries(3, true)" aria-label="Select all Step 4">Select</button>
          <button onclick="toggleStepForAllCountries(3, false)" aria-label="Deselect all Step 4">Deselect</button>
        </div>
      </div>
      //-->
      
      <div id="profileSection">
        <h3>Profiles</h3>
        <input type="text" id="profileName" placeholder="Enter profile name"
               style="width:100%; padding:5px; margin-bottom:10px; border:1px solid #ccc; border-radius:4px;"
               aria-label="Profile Name"/>
        <button onclick="saveProfile()" style="width:100%; margin-bottom:10px;" aria-label="Save Profile">
          Save Profile
        </button>
        <ul id="profileList"></ul>
      </div>
    </div>
    
    <!-- Vertical Drag Bar for resizing sidebar -->
    <div id="verticalDragBar"></div>

    <!-- Main content: Map (top), horizontal drag bar, and Quiz (bottom) -->
    <div id="main">
      <div id="mapWrapper">
        <iframe id="gmap_canvas" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" 
          src="https://maps.google.com/maps?width=800&amp;height=600&amp;hl=en&amp;q=%20+()&amp;t=&amp;z=12&amp;ie=UTF8&amp;iwloc=B&amp;output=embed">
        </iframe>
      </div>
      <div id="horizontalDragBar"></div>
      <div id="quiz">
        <h2>Quiz</h2>
        <button id="quizButton" onclick="quizButtonHandler()" aria-label="Show Question">Show Question</button>
        <div id="quizDisplay" style="margin-top:10px;"></div>
        
        <!-- HISTORY REVIEW SECTION -->
        <div id="historyReview">
          <h3>Review Question History</h3>
          <p>
            Enter number (max: <span id="maxHistory">200</span>) and click “Review History”.
          </p>
          <input type="number" id="historyCountInput" min="1" value="5" />
          <button onclick="reviewHistory()" aria-label="Review History">Review History</button>
          <div id="historyDisplay" style="margin-top:10px;"></div>
        </div>
        
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // DRAGGING / RESIZING LOGIC
    // ---------------------------
    let isDraggingVertical = false;
    let isDraggingHorizontal = false;
    let sidebar = null, verticalDragBar = null, horizontalDragBar = null, mapWrapper = null, mainContainer = null;
    
    window.addEventListener('DOMContentLoaded', () => {
      sidebar = document.getElementById('sidebar');
      verticalDragBar = document.getElementById('verticalDragBar');
      horizontalDragBar = document.getElementById('horizontalDragBar');
      mapWrapper = document.getElementById('mapWrapper');
      mainContainer = document.getElementById('main');
    
      verticalDragBar.addEventListener('mousedown', function(e) {
        isDraggingVertical = true;
        document.body.style.cursor = 'col-resize';
        e.preventDefault();
      });
      horizontalDragBar.addEventListener('mousedown', function(e) {
        isDraggingHorizontal = true;
        document.body.style.cursor = 'row-resize';
        e.preventDefault();
      });
      document.addEventListener('mousemove', function(e) {
        if (isDraggingVertical) {
          const newWidth = e.clientX;
          if (newWidth > 200 && newWidth < 800) {
            sidebar.style.width = newWidth + 'px';
          }
        }
        if (isDraggingHorizontal) {
          const rect = mainContainer.getBoundingClientRect();
          const offsetY = e.clientY - rect.top; 
          if (offsetY > 100 && offsetY < (rect.height - 100)) {
            mapWrapper.style.height = offsetY + 'px';
          }
        }
      });
      document.addEventListener('mouseup', function() {
        isDraggingVertical = false;
        isDraggingHorizontal = false;
        document.body.style.cursor = 'default';
      });
    });

    // ---------------------------
    // PERSISTING COLLAPSE STATE
    // ---------------------------
    let collapseState = {};
    function saveCollapseState() {
      localStorage.setItem("collapseState", JSON.stringify(collapseState));
    }
    function loadCollapseState() {
      const stored = localStorage.getItem("collapseState");
      if (stored) {
        try { collapseState = JSON.parse(stored); } 
        catch (e) { console.warn("Collapse state parse error", e); }
      }
    }

    // ---------------------------
    // QUIZ / TREE / PROFILE LOGIC
    // ---------------------------
    let data;
    let selections = {};
    // selectionsBackup stores individual branch state when parent is toggled off:
    let selectionsBackup = {};
    let currentQuizQuestion = null;
    // recentQuestions array is still used for no-repeat quiz logic:
    let recentQuestions = [];
    // Global variable to track current active profile name for history storage.
    let currentProfile = null;
    
    // Build initial selections from loaded data.
    function initSelections() {
      selections = {};
      for (const continent in data) {
        selections[continent] = {};
        for (const country in data[continent]) {
          selections[continent][country] = {};
          const headers = data[continent][country].header;
          for (const header in headers) {
            // Initially all steps are set to true.
            selections[continent][country][header] = headers[header].map(() => true);
          }
        }
      }
    }
    
    // Create a collapsible element.
    function createCollapsible(title, children, nodeId) {
      const wrapper = document.createElement('div');
      if (collapseState[nodeId] === undefined) collapseState[nodeId] = false;
      if (collapseState[nodeId]) wrapper.classList.add("expanded");
    
      const header = document.createElement('div');
      header.className = 'collapsible';
      if (typeof title === 'string') header.textContent = title;
      else header.appendChild(title);
      header.onclick = () => {
        if (wrapper.classList.contains("expanded")) {
          wrapper.classList.remove("expanded");
          collapseState[nodeId] = false;
        } else {
          wrapper.classList.add("expanded");
          collapseState[nodeId] = true;
        }
        saveCollapseState();
      };
      wrapper.appendChild(header);
    
      const content = document.createElement('div');
      content.className = 'content';
      children.forEach(child => content.appendChild(child));
      wrapper.appendChild(content);
    
      return wrapper;
    }
    
    async function renderTree() {
      loadCollapseState();
      if (!data) {
        data = await loadAJson("plonkit.json");
        initSelections();
      }
      const container = document.getElementById('treeContainer');
      container.innerHTML = "";
    
      // Loop through continents
      for (const continent in data) {
        let continentAllSelected = true;
        for (const country in data[continent]) {
          for (const header in data[continent][country].header) {
            if (selections[continent][country][header].some(v => !v)) { continentAllSelected = false; break; }
          }
        }
    
        // CONTINENT checkbox: use backup if available.
        const continentCheckbox = document.createElement('input');
        continentCheckbox.type = "checkbox";
        continentCheckbox.checked = continentAllSelected;
        continentCheckbox.onchange = (e) => {
          const newVal = e.target.checked;
          if (newVal) { // Re-enabling: restore backup if exists
            if (selectionsBackup[continent]) {
              selections[continent] = JSON.parse(JSON.stringify(selectionsBackup[continent]));
              delete selectionsBackup[continent];
            } else {
              for (const country in data[continent]) {
                for (const header in data[continent][country].header) {
                  selections[continent][country][header] = selections[continent][country][header].map(() => true);
                }
              }
            }
          } else { // Disabling: backup current state then disable children
            selectionsBackup[continent] = JSON.parse(JSON.stringify(selections[continent]));
            for (const country in data[continent]) {
              for (const header in data[continent][country].header) {
                selections[continent][country][header] = selections[continent][country][header].map(() => false);
              }
            }
          }
          renderTree();
        };
        const continentLabel = document.createElement('span');
        continentLabel.textContent = " " + continent;
        const continentHeaderDiv = document.createElement('div');
        continentHeaderDiv.appendChild(continentCheckbox);
        continentHeaderDiv.appendChild(continentLabel);
    
        // Process countries
        let countryNodes = [];
        for (const country in data[continent]) {
          let countryAllSelected = true;
          for (const header in data[continent][country].header) {
            if (selections[continent][country][header].some(v => !v)) { countryAllSelected = false; break; }
          }
          const countryCheckbox = document.createElement('input');
          countryCheckbox.type = "checkbox";
          countryCheckbox.checked = countryAllSelected;
          countryCheckbox.onchange = (e) => {
            const newVal = e.target.checked;
            if (newVal) {
              if (selectionsBackup[continent] && selectionsBackup[continent][country]) {
                selections[continent][country] = JSON.parse(JSON.stringify(selectionsBackup[continent][country]));
                // Remove backup for this branch
                delete selectionsBackup[continent][country];
              } else {
                for (const header in data[continent][country].header) {
                  selections[continent][country][header] = selections[continent][country][header].map(() => true);
                }
              }
            } else {
              if (!selectionsBackup[continent]) selectionsBackup[continent] = {};
              selectionsBackup[continent][country] = JSON.parse(JSON.stringify(selections[continent][country]));
              for (const header in data[continent][country].header) {
                selections[continent][country][header] = selections[continent][country][header].map(() => false);
              }
            }
            renderTree();
          };
          const countryLabel = document.createElement('span');
          countryLabel.textContent = " " + country;
          const countryHeaderDiv = document.createElement('div');
          countryHeaderDiv.appendChild(countryCheckbox);
          countryHeaderDiv.appendChild(countryLabel);
    
          let headerNodes = [];
          const headers = data[continent][country].header;
          for (const header in headers) {
            const headerCheckbox = document.createElement('input');
            headerCheckbox.type = "checkbox";
            headerCheckbox.checked = selections[continent][country][header].every(v => v);
            headerCheckbox.onchange = (e) => {
              const newVal = e.target.checked;
              // Backup and restore for header level:
              if (newVal) {
                if (selectionsBackup[continent] && selectionsBackup[continent][country] &&
                    selectionsBackup[continent][country][header]) {
                  selections[continent][country][header] = JSON.parse(JSON.stringify(selectionsBackup[continent][country][header]));
                  delete selectionsBackup[continent][country][header];
                } else {
                  selections[continent][country][header] = selections[continent][country][header].map(() => true);
                }
              } else {
                if (!selectionsBackup[continent]) selectionsBackup[continent] = {};
                if (!selectionsBackup[continent][country]) selectionsBackup[continent][country] = {};
                selectionsBackup[continent][country][header] = JSON.parse(JSON.stringify(selections[continent][country][header]));
                selections[continent][country][header] = selections[continent][country][header].map(() => false);
              }
              renderTree();
            };
            const headerLabel = document.createElement('span');
            headerLabel.textContent = " " + header;
            const headerDiv = document.createElement('div');
            headerDiv.appendChild(headerCheckbox);
            headerDiv.appendChild(headerLabel);
    
            let questionNodes = [];
            headers[header].forEach((step, index) => {
              const questionCheckbox = document.createElement('input');
              questionCheckbox.type = "checkbox";
              questionCheckbox.checked = selections[continent][country][header][index];
              questionCheckbox.onchange = (e) => {
                toggleStep(continent, country, header, index, e.target.checked);
              };
              const questionLabel = document.createElement('span');
              questionLabel.textContent = " Question " + (index + 1);
              const questionDiv = document.createElement('div');
              questionDiv.appendChild(questionCheckbox);
              questionDiv.appendChild(questionLabel);
              questionNodes.push(questionDiv);
            });
    
            const headerNodeId = "continent-" + continent + "-country-" + country + "-header-" + header;
            const headerCollapsible = createCollapsible(headerDiv, questionNodes, headerNodeId);
            headerNodes.push(headerCollapsible);
          }
          const countryNodeId = "continent-" + continent + "-country-" + country;
          const countryCollapsible = createCollapsible(countryHeaderDiv, headerNodes, countryNodeId);
          countryNodes.push(countryCollapsible);
        }
        const continentNodeId = "continent-" + continent;
        const continentCollapsible = createCollapsible(continentHeaderDiv, countryNodes, continentNodeId);
        container.appendChild(continentCollapsible);
      }
    }
    
    // Toggle an individual step (question) without affecting backups.
    function toggleStep(continent, country, header, index, checked) {
      selections[continent][country][header][index] = checked;
      renderTree();
    }
	
    // Global toggle for a particular step in all headers (used by the Global Step Selector UI).
	function toggleStepForAllCountries(stepIndex, newVal) {
	  for (let continent in data) {
	    for (let country in data[continent]) {
	      for (let header in data[continent][country].header) {
	        if (selections[continent][country][header][stepIndex] !== undefined) {
	          selections[continent][country][header][stepIndex] = newVal;
	        }
	      }
	    }
	  }
	  renderTree();
	}

    // ---------------------------
    // PROFILE FUNCTIONS
    // ---------------------------
    function saveProfile() {
      const name = document.getElementById('profileName').value.trim();
      if (!name) { alert("Please enter a profile name"); return; }
      let profiles = loadProfiles();
      profiles[name] = JSON.parse(JSON.stringify(selections));
      localStorage.setItem("profileSelections", JSON.stringify(profiles));
      renderProfileList();
      // Set the current active profile for history storage:
      currentProfile = name;
    }
    function updateProfile(name) {
      let profiles = loadProfiles();
      if (!profiles[name]) { alert("Profile does not exist. Please save it first."); return; }
      profiles[name] = JSON.parse(JSON.stringify(selections));
      localStorage.setItem("profileSelections", JSON.stringify(profiles));
      renderProfileList();
    }
    function loadProfiles() {
      const profilesData = localStorage.getItem("profileSelections");
      try { return profilesData ? JSON.parse(profilesData) : {}; }
      catch(e) { console.error("Error parsing localStorage profile data:", e); return {}; }
    }
    function loadProfile(name) {
      const profiles = loadProfiles();
      if (profiles[name]) {
        selections = profiles[name];
        renderTree();
        currentProfile = name; // set current profile when loaded
      }
    }
    function deleteProfile(name) {
      let profiles = loadProfiles();
      if (profiles[name]) {
        delete profiles[name];
        localStorage.setItem("profileSelections", JSON.stringify(profiles));
        renderProfileList();
      }
    }
    function renderProfileList() {
      const profileList = document.getElementById('profileList');
      profileList.innerHTML = "";
      const profiles = loadProfiles();
      for (let name in profiles) {
        const li = document.createElement('li');
        li.textContent = name + " ";
        const loadBtn = document.createElement('button');
        loadBtn.textContent = "Load";
        loadBtn.setAttribute('aria-label', `Load profile ${name}`);
        loadBtn.addEventListener('click', () => loadProfile(name));
        li.appendChild(loadBtn);
        const updateBtn = document.createElement('button');
        updateBtn.textContent = "Update";
        updateBtn.setAttribute('aria-label', `Update profile ${name}`);
        updateBtn.addEventListener('click', () => updateProfile(name));
        li.appendChild(updateBtn);
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = "Delete";
        deleteBtn.setAttribute('aria-label', `Delete profile ${name}`);
        deleteBtn.addEventListener('click', () => deleteProfile(name));
        li.appendChild(deleteBtn);
        profileList.appendChild(li);
      }
    }
	
    // ---------------------------
    // QUIZ FUNCTIONS & QUESTION HISTORY
    // ---------------------------
    // Get all selected question objects.
    function getAllSelectedQuestions() {
      let available = [];
      for (const continent in data) {
        for (const country in data[continent]) {
          const headers = data[continent][country].header;
          for (const header in headers) {
            headers[header].forEach((step, index) => {
              if (selections[continent][country][header][index]) {
                available.push({
                  id: continent + "-" + country + "-" + header + "-" + index,
                  continent, country, header, index, data: step
                });
              }
            });
          }
        }
      }
      return available;
    }
    
    function isImage(url) { return (url.match(/\.(jpeg|jpg|gif|png)$/) != null); }
    
    // Pick a random question ensuring no immediate repeats.
    function pickRandomQuestion() {
      const all = getAllSelectedQuestions();
      const available = all.filter(q => !recentQuestions.includes(q.id));
      if (available.length === 0) {
        recentQuestions = [];
        return pickRandomQuestion();
      }
      const picked = available[Math.floor(Math.random() * available.length)];
      recentQuestions.push(picked.id);
      if (recentQuestions.length > 20) recentQuestions.shift();
      return picked;
    }
    
    // Add the question to history (stored per profile).
    function addToHistory(questionObj) {
      if (!currentProfile) return; // no profile active
      const historyKey = "questionHistory_" + currentProfile;
      let history = JSON.parse(localStorage.getItem(historyKey)) || [];
      // Append the current question object (could include timestamp if desired)
      history.push(questionObj);
      // Cap the history length at 200
      if (history.length > 200) history = history.slice(history.length - 200);
      localStorage.setItem(historyKey, JSON.stringify(history));
    }
    
    // Main quiz button handler.
    function quizButtonHandler() {
      if (currentQuizQuestion && !currentQuizQuestion.answerShown) {
        // Show answer
        const headerEl = document.getElementById('quizHeader');
        if (headerEl) {
          headerEl.innerHTML = `${currentQuizQuestion.country} - ${currentQuizQuestion.header} (Question ${currentQuizQuestion.index + 1})`;
        }
        const answerDiv = document.createElement('div');
        answerDiv.className = 'answer';
        answerDiv.innerHTML = currentQuizQuestion.data.html;
        const count = incrementQuestionCount(currentQuizQuestion.id);
        const countText = document.createElement('div');
        countText.style.fontSize = "0.9em";
        countText.style.marginTop = "5px";
        countText.style.color = "#555";
        countText.textContent = `This question has been viewed ${count} time${count === 1 ? '' : 's'}.`;
        answerDiv.appendChild(countText);
        document.getElementById('quizDisplay').appendChild(answerDiv);
        currentQuizQuestion.answerShown = true;
        // Add to history when answer is shown
        addToHistory(currentQuizQuestion);
        document.getElementById('quizButton').textContent = "Next Question";
      } else {
        const allAvailable = getAllSelectedQuestions();
        if (allAvailable.length === 0) {
          alert("No entries selected for the quiz. Please adjust your selections.");
          return;
        }
        const randomEntry = pickRandomQuestion();
        currentQuizQuestion = { ...randomEntry, answerShown: false };
        currentQuizQuestion.fullHeader = `${randomEntry.country} - ${randomEntry.header} (Question ${randomEntry.index + 1})`;
        let questionContent = "";
        if (isImage(randomEntry.data.url)) {
          questionContent = `<img src="${randomEntry.data.url}" alt="Quiz Image" style="height:500px; width:auto; display:block; margin:0 auto; object-fit: contain;"/>`;
        } else {
          questionContent = `<iframe src="${randomEntry.data.url}" style="width:100%; height:300px;" frameborder="0"></iframe>`;
        }
        document.getElementById('quizDisplay').innerHTML =
          `<h2 id="quizHeader">Question</h2>
           <div>${questionContent}</div>`;
        document.getElementById('quizButton').textContent = "Show Answer";
      }
    }
    
    // Increment view count for a given question.
    function incrementQuestionCount(questionId) {
      let countData = localStorage.getItem('questionDisplayCounts');
      let counts = countData ? JSON.parse(countData) : {};
      counts[questionId] = (counts[questionId] || 0) + 1;
      localStorage.setItem('questionDisplayCounts', JSON.stringify(counts));
      return counts[questionId];
    }
    function getQuestionCount(questionId) {
      let countData = localStorage.getItem('questionDisplayCounts');
      let counts = countData ? JSON.parse(countData) : {};
      return counts[questionId] || 0;
    }
    
    // History review: display last n seen questions in randomized order.
    function reviewHistory() {
      if (!currentProfile) {
        alert("Please load or save a profile to review question history.");
        return;
      }
      const n = parseInt(document.getElementById('historyCountInput').value);
      const historyKey = "questionHistory_" + currentProfile;
      let history = JSON.parse(localStorage.getItem(historyKey)) || [];
      if (history.length === 0) {
        alert("No history available for the current profile.");
        return;
      }
      // Enforce maximum cap (200)
      const maxCap = 200;
      document.getElementById('maxHistory').textContent = maxCap;
      if (n > history.length) {
        alert(`Only ${history.length} questions stored in history.`);
        return;
      }
      // Get the last n questions (preserving order) then shuffle.
      let lastN = history.slice(history.length - n);
      // Shuffle lastN using Fisher-Yates algorithm.
      for (let i = lastN.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [lastN[i], lastN[j]] = [lastN[j], lastN[i]];
      }
      // Display the shuffled history in the historyDisplay div.
      const displayDiv = document.getElementById('historyDisplay');
      displayDiv.innerHTML = "<h4>Randomized History:</h4>";
      lastN.forEach((q, idx) => {
        const qDiv = document.createElement('div');
        qDiv.style.borderBottom = "1px dotted #ccc";
        qDiv.style.padding = "5px 0";
        qDiv.innerHTML = `<strong>${q.country} - ${q.header} (Question ${q.index + 1})</strong>: ${q.data.url}`;
        displayDiv.appendChild(qDiv);
      });
    }
    
    async function loadAJson(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) { throw new Error(`Network response was not ok (status: ${response.status})`); }
        const jsonData = await response.json();
        return jsonData;
      } catch (error) {
        console.error("Failed to load JSON:", error);
        throw error;
      }
    }
    
    window.init = async function() {
      data = await loadAJson("plonkit.json");
      initSelections();
      await renderTree();
      renderProfileList();
    };

    // Optional: Use space bar to trigger quiz button.
    document.addEventListener('keydown', (e) => {
      if (e.code === "Space") {
        e.preventDefault();
        quizButtonHandler();
      }
    });
  </script>
</body>
</html>
