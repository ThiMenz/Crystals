<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>World Quiz App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2, h3 { margin-top: 1em; }
    ul { list-style: none; padding: 0; }
    label { display: block; margin: 5px 0; }
    #quizDisplay img { display: block; margin: 10px auto; max-width: 100%; max-height: 300px; object-fit: contain; }
    #profileSection button { margin-left: 5px; padding: 3px 6px; font-size: 0.85em; }
  </style>
</head>
<body>
  <h2>Select Topics</h2>
  <div id="selectionTree"></div>
  <hr />
  <div id="profileSection">
    <h2>Profiles</h2>
    <input type="text" id="profileName" placeholder="Enter profile name" />
    <button onclick="saveProfile()">Save</button>
    <ul id="profileList"></ul>
  </div>
  <hr />
  <h2>Quiz</h2>
  <button onclick="startQuiz()">Start Quiz</button>
  <div id="quizDisplay"></div>

  <script>
    const data = {/* your original data object here */};
    let selections = {};
    let currentQuizQueue = [], currentQuizQuestion = null;

    function initSelections() {
      for (const continent in data) {
        selections[continent] = {};
        for (const country in data[continent]) {
          selections[continent][country] = {};
          for (const header in data[continent][country].header) {
            selections[continent][country][header] = data[continent][country].header[header].map(() => false);
          }
        }
      }
    }

    function renderTree() {
      const container = document.getElementById("selectionTree");
      container.innerHTML = "";
      for (const continent in data) {
        const continentDiv = document.createElement("div");
        const continentCheckbox = document.createElement("input");
        continentCheckbox.type = "checkbox";
        continentCheckbox.onchange = (e) => {
          const newVal = e.target.checked;
          for (const country in data[continent]) {
            for (const header in data[continent][country].header) {
              selections[continent][country][header] = selections[continent][country][header].map(() => newVal);
            }
          }
          renderTree();
        };
        continentDiv.appendChild(continentCheckbox);
        continentDiv.appendChild(document.createTextNode(continent));
        for (const country in data[continent]) {
          const countryDiv = document.createElement("div");
          countryDiv.style.marginLeft = "20px";
          countryDiv.appendChild(document.createTextNode(country));
          for (const header in data[continent][country].header) {
            const headerDiv = document.createElement("div");
            headerDiv.style.marginLeft = "20px";
            headerDiv.appendChild(document.createTextNode(header));
            data[continent][country].header[header].forEach((_, i) => {
              const label = document.createElement("label");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.checked = selections[continent][country][header][i];
              checkbox.onchange = (e) => {
                selections[continent][country][header][i] = e.target.checked;
              };
              label.appendChild(checkbox);
              label.appendChild(document.createTextNode(` Step ${i + 1}`));
              headerDiv.appendChild(label);
            });
            countryDiv.appendChild(headerDiv);
          }
          continentDiv.appendChild(countryDiv);
        }
        container.appendChild(continentDiv);
      }
    }

    function saveProfile() {
      const name = document.getElementById("profileName").value;
      if (!name) return alert("Enter profile name");
      let profiles = loadProfiles();
      profiles[name] = JSON.parse(JSON.stringify(selections));
      setCookie("profileSelections", JSON.stringify(profiles), 30);
      renderProfileList();
    }

    function loadProfiles() {
      const raw = getCookie("profileSelections");
      return raw ? JSON.parse(raw) : {};
    }

    function loadProfile(name) {
      const profiles = loadProfiles();
      if (profiles[name]) {
        selections = JSON.parse(JSON.stringify(profiles[name]));
        renderTree();
      }
    }

    function deleteProfile(name) {
      let profiles = loadProfiles();
      delete profiles[name];
      setCookie("profileSelections", JSON.stringify(profiles), 30);
      renderProfileList();
    }

    function updateProfile(name) {
      let profiles = loadProfiles();
      if (profiles[name]) {
        profiles[name] = JSON.parse(JSON.stringify(selections));
        setCookie("profileSelections", JSON.stringify(profiles), 30);
        renderProfileList();
        alert(`Profile "${name}" has been updated.`);
      }
    }

    function renderProfileList() {
      const ul = document.getElementById("profileList");
      ul.innerHTML = "";
      const profiles = loadProfiles();
      for (const name in profiles) {
        const li = document.createElement("li");
        li.innerHTML = `${name} 
          <button onclick="loadProfile('${name}')">Load</button> 
          <button onclick="deleteProfile('${name}')">Delete</button>
          <button onclick="updateProfile('${name}')">Update</button>`;
        ul.appendChild(li);
      }
    }

    function startQuiz() {
      currentQuizQueue = [];
      for (const continent in selections) {
        for (const country in selections[continent]) {
          for (const header in selections[continent][country]) {
            selections[continent][country][header].forEach((val, i) => {
              if (val) {
                currentQuizQueue.push({
                  continent,
                  country,
                  header,
                  index: i,
                  data: data[continent][country].header[header][i]
                });
              }
            });
          }
        }
      }
      quizButtonHandler();
    }

    function quizButtonHandler() {
      if (currentQuizQueue.length === 0) {
        document.getElementById("quizDisplay").innerHTML = "<p>All done!</p>";
        return;
      }
      const randomIndex = Math.floor(Math.random() * currentQuizQueue.length);
      const randomEntry = currentQuizQueue.splice(randomIndex, 1)[0];
      currentQuizQuestion = randomEntry;
      const questionContent = randomEntry.data.url
        ? `<img src="${randomEntry.data.url}" alt="Quiz Image" style="max-width:100%; max-height:300px; object-fit:contain;" />`
        : "(No image available)";
      document.getElementById("quizDisplay").innerHTML = `
        <div>${questionContent}</div>
        <button onclick="showAnswer()">Show Answer</button>
      `;
    }

    function showAnswer() {
      document.getElementById("quizDisplay").innerHTML += `
        <div class="answer">
          <h3>${currentQuizQuestion.country} - ${currentQuizQuestion.header} (Question ${currentQuizQuestion.index + 1})</h3>
          ${currentQuizQuestion.data.html}
          <br/><button onclick="quizButtonHandler()">Next</button>
        </div>
      `;
    }

    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 86400000).toUTCString();
      document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      return parts.length === 2 ? decodeURIComponent(parts.pop().split(';').shift()) : null;
    }

    initSelections();
    renderTree();
    renderProfileList();
  </script>
</body>
</html>
